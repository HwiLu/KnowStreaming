<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TopicConnectionDao">
    <resultMap id="TopicConnectionMap" type="com.xiaojukeji.kafka.manager.common.entity.pojo.gateway.TopicConnectionDO">
        <id property="id"                   column="id"/>
        <result property="clusterId"        column="cluster_id"/>
        <result property="topicName"        column="topic_name"/>
        <result property="type"             column="type"/>
        <result property="appId"            column="app_id"/>
        <result property="ip"               column="ip"/>
        <result property="clientVersion"    column="client_version"/>
        <result property="clientId"         column="client_id"/>
        <result property="realConnectTime"  column="real_connect_time"/>
        <result property="createTime"       column="create_time"/>
    </resultMap>

    <insert id="batchReplace" parameterType="java.util.List">
        insert into topic_connections (cluster_id, topic_name, `type`, app_id, ip, client_version, client_id, real_connect_time, create_time)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.clusterId}, #{item.topicName}, #{item.type}, #{item.appId}, #{item.ip}, #{item.clientVersion}, #{item.clientId}, #{item.realConnectTime}, #{item.createTime})
        </foreach>
        on duplicate key update
            real_connect_time = IF(real_connect_time > VALUES(real_connect_time), real_connect_time, VALUES(real_connect_time)),
            cluster_id = VALUES(cluster_id),
            topic_name = VALUES(topic_name),
            `type` = VALUES(`type`),
            app_id = VALUES(app_id),
            ip = VALUES(ip),
            client_version = VALUES(client_version),
            client_id = VALUES(client_id),
            create_time = VALUES(create_time)
    </insert>

    <select id="getByTopicName" parameterType="java.util.Map" resultMap="TopicConnectionMap">
        <![CDATA[
        SELECT * FROM topic_connections
        WHERE cluster_id = #{clusterId}
          AND topic_name = #{topicName}
          AND create_time >= #{startTime} AND #{endTime} >= create_time
    ]]>
    </select>

    <select id="getByAppId" parameterType="java.util.Map" resultMap="TopicConnectionMap">
        <![CDATA[
        SELECT * FROM topic_connections
        WHERE app_id = #{appId}
          AND create_time >= #{startTime} AND #{endTime} >= create_time
    ]]>
    </select>

    <select id="getByClusterAndAppId" parameterType="java.util.Map" resultMap="TopicConnectionMap">
        <![CDATA[
        SELECT * FROM topic_connections
        WHERE app_id = #{appId}
          AND cluster_id = #{clusterId}
          AND create_time >= #{startTime}
          AND #{endTime} >= create_time
        ]]>
    </select>
</mapper>